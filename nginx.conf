worker_processes  auto;

events {
    worker_connections 4096;
}

error_log /var/log/nginx/error.log info;

rtmp_auto_push on;
rtmp_auto_push_reconnect 1s;
rtmp_socket_dir /tmp;

rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application vod {
            play /data/;
            gop_cache on;
        }

        application youtube {
            live on;
            allow publish all;
            gop_cache on;

            exec /usr/local/bin/ffmpeg -i rtmp://localhost:1935/youtube/$name -c copy -f flv rtmp://a.rtmp.youtube.com/live2/$name 2>>/tmp/ffmpeg-youtube.log;
            push rtmp://localhost:1935/stream/;
        }

        application facebook {
            live on;
            allow publish all;
            gop_cache on;

            exec /usr/local/bin/ffmpeg -i rtmp://localhost:1935/facebook/$name -c copy -f flv rtmps://live-api-s.facebook.com:443/rtmp/$name 2>>/tmp/ffmpeg-facebook.log;
            push rtmp://localhost:1935/stream/;
        }

        application stream {
            live on;
            allow publish all;
            gop_cache on;

            push rtmp://localhost:1935/record/;

            exec /usr/local/bin/ffmpeg -i rtmp://localhost:1935/stream/$name -vsync 1
                -c:v libx264 -c:a copy -vf "scale=852:-2"  -copyts -start_at_zero -sws_flags lanczos -keyint_min 30 -force_key_frames "expr:gte(t,n_forced*1)" -tune zerolatency -preset veryfast -crf 20 -maxrate 1200k -bufsize 2400k -threads 16 -f flv rtmp://localhost:1935/show/$name_480
                -c:v libx264 -c:a copy -vf "scale=1270:-1" -copyts -start_at_zero -sws_flags lanczos -keyint_min 30 -force_key_frames "expr:gte(t,n_forced*1)" -tune zerolatency -preset veryfast -crf 20 -maxrate 2608k -bufsize 5216k -threads 16 -f flv rtmp://localhost:1935/show/$name_720
                -c copy -f flv rtmp://localhost:1935/show/$name_src 2>>/tmp/ffmpeg.log;
        }

        application show {
            live on;
            hls on;
            hls_fragment_naming system;
            hls_fragment 3;
            hls_playlist_length 10;
            hls_path /tmp/hls;
            hls_nested on;
            hls_cleanup on;

            hls_variant _480 BANDWIDTH=1200000,CODECS="avc1.4d401f,mp4a.40.2",RESOLUTION="480p"; # Medium bitrate, SD resolution
            hls_variant _720 BANDWIDTH=2048000,CODECS="avc1.4d401f,mp4a.40.2",RESOLUTION="720p"; # High bitrate, HD 720p resolution
            hls_variant _src BANDWIDTH=4096000,CODECS="avc1.4d401f,mp4a.40.2",RESOLUTION="1080p"; # Source bitrate, source resolution
        }

        application record {
            live on;

            exec_push mkdir -m 764 /data/$name;

            record all;
            record_path /tmp/;
            record_unique on;
            record_suffix -%d-%b-%y-%H%M%S.flv;

            exec_record_done bash -c "/usr/local/bin/ffmpeg -y -i $path -c copy /data/$basename.mp4 && rm $path";
        }
    }
}

http {
    access_log /var/log/nginx/access.log combined;
    root /www/static;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    vod_mode                           local;
	vod_metadata_cache                 metadata_cache 16m;
	vod_response_cache                 response_cache 512m;
	vod_last_modified_types            *;
	vod_segment_duration               9000;
	vod_align_segments_to_key_frames   on;
	vod_hls_segment_file_name_prefix   "segment";

	vod_manifest_segment_durations_mode accurate;

	open_file_cache          max=1000 inactive=5m;
	open_file_cache_valid    2m;
	open_file_cache_min_uses 1;
	open_file_cache_errors   on;

	aio on;

    server {
        listen 8080;
        add_header 'Cache-Control' 'no-cache';
        add_header 'Access-Control-Allow-Origin' '*';

        location /vod_hls {
			vod hls;
			alias /data/;
			add_header Access-Control-Allow-Headers '*';
			add_header Access-Control-Allow-Origin '*';
			add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';
		}

        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
        }

        location /dash {
            root /tmp;
        }

        location /live {
            flv_live on;
            chunked_transfer_encoding  on;
        }

        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /www/static;
        }

        location /crossdomain.xml {
            default_type text/xml;
            expires 24h;
        }

        location /view/ {
            rewrite ^/view/(.*)? /hls.html break;
        }
    }
}